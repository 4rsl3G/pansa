<%
  const p = payload || {};

  const coverStr = String(cover || "");
  const titleStr = String(tname || p.name || "");
  const langStr  = String(lang || "en");

  // safe for putting inside double-quoted JS string
  const jsSafe = (s) => String(s || "").replace(/\\/g, "\\\\").replace(/"/g, '\\"');

  const coverSafe = jsSafe(coverStr);
  const titleSafe = jsSafe(titleStr);
  const langSafe  = jsSafe(langStr);

  const total = Number(p.total || 0);
  const epNum = Number(ep || 1);

  const prevEp = Math.max(1, epNum - 1);
  const nextEp = (total > 0) ? Math.min(total, epNum + 1) : (epNum + 1);
  const isLast = total > 0 && epNum >= total;

  const prevHref =
    `/watch/${encodeURIComponent(code)}/${prevEp}` +
    `?lang=${encodeURIComponent(langStr)}` +
    `&cover=${encodeURIComponent(coverStr)}` +
    `&name=${encodeURIComponent(titleStr)}`;

  const nextHref = isLast
    ? ""
    : `/watch/${encodeURIComponent(code)}/${nextEp}` +
      `?lang=${encodeURIComponent(langStr)}` +
      `&cover=${encodeURIComponent(coverStr)}` +
      `&name=${encodeURIComponent(titleStr)}`;

  const epsHref = `/t/${encodeURIComponent(code)}?lang=${encodeURIComponent(langStr)}`;

  // ✅ endpoint untuk ambil play url via jQuery (tidak expose di HTML)
  const apiPlayUrl =
    `/api/play/${encodeURIComponent(code)}/${encodeURIComponent(epNum)}` +
    `?lang=${encodeURIComponent(langStr)}`;
%>

<section class="wrap pb-14">
  <div class="watchTop" data-aos="fade-up">
    <div class="watchNow">Now playing</div>
    <div class="watchTitle line-clamp-2">
      <%= p.name %>
      <span class="muted">• EP <%= epNum %>/<%= total || "-" %></span>
    </div>

    <div class="watchActions">
      <a class="pill" href="<%= epsHref %>"><i class="ri-list-check-2"></i> Episodes</a>

      <a class="pill" href="<%= prevHref %>">
        <i class="ri-skip-back-mini-fill"></i>
      </a>

      <a class="pill" id="btnNextLink" href="<%= nextHref || '#' %>" <%= isLast ? 'aria-disabled="true"' : '' %>>
        <i class="ri-skip-forward-mini-fill"></i>
      </a>
    </div>
  </div>

  <div class="playerWrap" data-aos="fade-up" data-aos-delay="80">
    <div class="playerHeader">
      <div class="chip"><i class="ri-video-line"></i> PanStream Player</div>
      <div class="chip"><i class="ri-timer-line"></i> Expires in <%= p.expires_in || "-" %>s</div>
    </div>

    <div class="playerStage">
      <video id="psVideo" playsinline webkit-playsinline preload="metadata"></video>

      <div class="playerLoading" id="playerLoading">
        <div class="spin"></div>
        <div class="loadingTxt" id="loadingTxt">Loading video…</div>
      </div>

      <div class="playerOverlay" id="tapOverlay">
        <button class="bigPlay" id="bigPlay"><i class="ri-play-fill"></i></button>
      </div>

      <div class="toast" id="playerToast">
        <div class="toastTitle" id="toastTitle">Stream issue</div>
        <div class="toastDesc" id="toastDesc">Refreshing link…</div>
        <button class="toastBtn" id="toastBtn">Retry</button>
      </div>
    </div>

    <div class="playerControls">
      <div class="timeRow">
        <span id="tCur">0:00</span>
        <input id="seek" type="range" min="0" max="1000" value="0" />
        <span id="tDur">0:00</span>
      </div>

      <div class="ctlRow">
        <button class="ctlBtn" id="btnPlay"><i class="ri-play-fill"></i></button>
        <button class="ctlBtn" id="btnMute"><i class="ri-volume-up-line"></i></button>

        <div class="ctlGroup">
          <i class="ri-sound-module-line"></i>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="1" />
        </div>

        <div class="ctlGroup">
          <i class="ri-hd-line"></i>
          <select id="quality">
            <option value="720">720p</option>
            <option value="1080">1080p</option>
            <option value="480">480p</option>
          </select>
        </div>

        <button class="ctlBtn" id="btnFull"><i class="ri-fullscreen-line"></i></button>
        <button class="ctlBtn" id="btnNext"><i class="ri-skip-forward-mini-fill"></i></button>
      </div>

      <div class="watchBottomRow">
        <button class="pill" id="toggleAutoNext"><span class="muted">Auto Next:</span> <b id="autoState">ON</b></button>
        <button class="pill" id="btnReattach"><i class="ri-refresh-line"></i> Re-attach</button>
      </div>
    </div>
  </div>
</section>

<script>
  window.__PS__ = {
    lang: "<%- langSafe %>",
    code: "<%- jsSafe(code) %>",
    ep: <%= epNum %>,
    total: <%= total %>,
    title: "<%- titleSafe %>",
    cover: "<%- coverSafe %>",
    apiPlayUrl: "<%- jsSafe(apiPlayUrl) %>",
    nextUrl: "<%- jsSafe(nextHref) %>"
  };
</script>
