<%
  const p = payload || {};
  const v = p.video || {};
  const coverSafe = (cover || "").replace(/"/g,'&quot;');
  const titleSafe = (tname || p.name || "").replace(/"/g,'&quot;');
%>

<section class="wrap pb-14">
  <div class="watchTop" data-aos="fade-up">
    <div class="watchNow">Now playing</div>
    <div class="watchTitle line-clamp-2"><%= p.name %> <span class="muted">• EP <%= ep %>/<%= p.total || "-" %></span></div>

    <div class="watchActions">
      <a class="pill" href="/t/<%= code %>?lang=<%= lang %>"><i class="ri-list-check-2"></i> Episodes</a>
      <a class="pill" href="/watch/<%= code %>/<%= Math.max(1, ep-1) %>?lang=<%= lang %>&cover=<%= encodeURIComponent(cover||'') %>&name=<%= encodeURIComponent(tname||p.name||'') %>">
        <i class="ri-skip-back-mini-fill"></i>
      </a>
      <a class="pill" id="btnNextLink"
         href="/watch/<%= code %>/<%= Math.min((p.total||ep), ep+1) %>?lang=<%= lang %>&cover=<%= encodeURIComponent(cover||'') %>&name=<%= encodeURIComponent(tname||p.name||'') %>">
        <i class="ri-skip-forward-mini-fill"></i>
      </a>
    </div>
  </div>

  <div class="playerWrap" data-aos="fade-up" data-aos-delay="80">
    <div class="playerHeader">
      <div class="chip"><i class="ri-video-line"></i> PanStream Player</div>
      <div class="chip"><i class="ri-timer-line"></i> Expires in <%= p.expires_in || "-" %>s</div>
    </div>

    <div class="playerStage">
      <video id="psVideo" playsinline webkit-playsinline preload="metadata"></video>

      <div class="playerLoading" id="playerLoading">
        <div class="spin"></div>
        <div class="loadingTxt" id="loadingTxt">Loading video…</div>
      </div>

      <div class="playerOverlay" id="tapOverlay">
        <button class="bigPlay" id="bigPlay"><i class="ri-play-fill"></i></button>
      </div>

      <div class="toast" id="playerToast">
        <div class="toastTitle" id="toastTitle">Stream issue</div>
        <div class="toastDesc" id="toastDesc">Refreshing link…</div>
        <button class="toastBtn" id="toastBtn">Retry</button>
      </div>
    </div>

    <div class="playerControls">
      <div class="timeRow">
        <span id="tCur">0:00</span>
        <input id="seek" type="range" min="0" max="1000" value="0" />
        <span id="tDur">0:00</span>
      </div>

      <div class="ctlRow">
        <button class="ctlBtn" id="btnPlay"><i class="ri-play-fill"></i></button>
        <button class="ctlBtn" id="btnMute"><i class="ri-volume-up-line"></i></button>

        <div class="ctlGroup">
          <i class="ri-sound-module-line"></i>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="1" />
        </div>

        <div class="ctlGroup">
          <i class="ri-hd-line"></i>
          <select id="quality">
            <option value="720">720p</option>
            <option value="1080">1080p</option>
            <option value="480">480p</option>
          </select>
        </div>

        <button class="ctlBtn" id="btnFull"><i class="ri-fullscreen-line"></i></button>
        <button class="ctlBtn" id="btnNext"><i class="ri-skip-forward-mini-fill"></i></button>
      </div>

      <div class="watchBottomRow">
        <button class="pill" id="toggleAutoNext"><span class="muted">Auto Next:</span> <b id="autoState">ON</b></button>
        <button class="pill" id="btnReattach"><i class="ri-refresh-line"></i> Re-attach</button>
      </div>
    </div>
  </div>
</section>

<script>
  window.__PS__ = {
    lang: "<%= lang %>",
    code: "<%= code %>",
    ep: <%= ep %>,
    total: <%= Number(p.total || 0) %>,
    title: "<%- titleSafe %>",
    cover: "<%- coverSafe %>",
    refreshUrl: "/api/play/<%= code %>/<%= ep %>?lang=<%= lang %>",
    nextUrl: "/watch/<%= code %>/<%= Math.min((p.total||ep), ep+1) %>?lang=<%= lang %>&cover=<%= encodeURIComponent(cover||'') %>&name=<%= encodeURIComponent(tname||p.name||'') %>",
    src720: "<%= (v.video_720 || '') %>",
    src1080: "<%= (v.video_1080 || '') %>",
    src480: "<%= (v.video_480 || '') %>"
  };
</script>
